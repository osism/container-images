ARG PYTHON_VERSION=3.7
FROM python:${PYTHON_VERSION}-alpine

ARG VERSION=yoga

ARG USER_ID=45000
ARG GROUP_ID=45000

COPY files/requirements.txt /requirements.txt

# hadolint ignore=DL3013
RUN apk add --no-cache \
      dumb-init \
      build-base \
      linux-headers \
      libffi-dev \
    && pip3 --no-cache-dir install --upgrade pip \
    && pip3 --no-cache-dir install python-openstackclient \
    && pip3 --no-cache-dir install python-barbicanclient \
    && pip3 --no-cache-dir install python-ceilometerclient \
    && pip3 --no-cache-dir install python-cinderclient \
    && pip3 --no-cache-dir install python-cloudkittyclient \
    && pip3 --no-cache-dir install python-designateclient \
    && pip3 --no-cache-dir install python-fuelclient \
    && pip3 --no-cache-dir install python-glanceclient \
    #&& pip3 --no-cache-dir install python-gnocchiclient \
    && pip3 --no-cache-dir install python-heatclient \
    && pip3 --no-cache-dir install python-magnumclient \
    && pip3 --no-cache-dir install python-manilaclient \
    && pip3 --no-cache-dir install python-mistralclient \
    && pip3 --no-cache-dir install python-monascaclient \
    && pip3 --no-cache-dir install python-muranoclient \
    && pip3 --no-cache-dir install python-neutronclient \
    && pip3 --no-cache-dir install python-novaclient \
    && pip3 --no-cache-dir install python-saharaclient \
    && pip3 --no-cache-dir install python-senlinclient \
    && pip3 --no-cache-dir install python-swiftclient \
    && pip3 --no-cache-dir install python-troveclient \
    && apk del build-base linux-headers libffi-dev \
    && openstack complete > /osc.bash_completion \
    && addgroup -g $GROUP_ID dragon \
    && adduser -D -u $USER_ID -G dragon dragon \
    && mkdir /configuration \
    && chown -R dragon: /configuration

USER dragon
WORKDIR /configuration

VOLUME ["/configuration"]

ENTRYPOINT ["/usr/bin/dumb-init", "--"]
CMD ["openstack"]

LABEL "org.opencontainers.image.documentation"="https://docs.osism.tech" \
      "org.opencontainers.image.licenses"="ASL 2.0" \
      "org.opencontainers.image.source"="https://github.com/osism/container-images" \
      "org.opencontainers.image.url"="https://www.osism.tech" \
      "org.opencontainers.image.vendor"="OSISM GmbH"
